function fix_phases_height(){if(!is_mobile()){var a=Math.max.apply(null,$("div.tasks-phases .panel-body").map(function(){return $(this).outerHeight()}).get());$("div.tasks-phases .panel-body").css("min-height",a+"px")}}function milestones_switch_view(){$("#milestones-table").toggleClass("hide"),$(".tasks-phases").toggleClass("hide"),$("#milestones-table").hasClass("hide")?$(".new-task-phase").removeClass("hide"):$(".new-task-phase").addClass("hide"),fix_phases_height()}function manage_discussion(a){var b=$(a).serialize(),c=a.action;return $.post(c,b).done(function(a){a=JSON.parse(a),1==a.success&&alert_float("success",a.message),$(".table-project-discussions").DataTable().ajax.reload(),$("#discussion").modal("hide")}),!1}function manage_timesheets(a){var b=$(a).serialize(),c=a.action;$.post(c,b).done(function(a){a=JSON.parse(a),1==a.success?alert_float("success",a.message):alert_float("warning",a.message),setTimeout(function(){window.location.reload()},1e3)})}function edit_timesheet(a,b){$('#timesheet select[name="timesheet_staff_id"]').attr("data-staff_id",$(a).attr("data-timesheet_staff_id")),$('select[name="timesheet_task_id"]').selectpicker("val",$(a).attr("data-timesheet_task_id")),$('input[name="timer_id"]').val(b),$('input[name="start_time"]').val($(a).attr("data-start_time")),$('input[name="end_time"]').val($(a).attr("data-end_time")),$('select[name="timesheet_task_id"]').change(),$("#timesheet").modal("show"),setTimeout(function(){var b=$(a).attr("data-tags").split(",");for(var c in b)$("#timesheet #tags").tagit("createTag",b[c])},500)}function new_discussion(){$("#discussion").modal("show"),$("#discussion .edit-title").addClass("hide")}function new_milestone(){$("#milestone").modal("show"),$("#milestone .edit-title").addClass("hide")}function new_timesheet(){$("#timesheet").modal("show")}function edit_milestone(a,b){var c=$(a).data("description-visible-to-customer");1==c?$('input[name="description_visible_to_customer"]').prop("checked",!0):$('input[name="description_visible_to_customer"]').prop("checked",!1),$("#additional_milestone").append(hidden_input("id",b)),$('#milestone input[name="name"]').val($(a).data("name")),$('#milestone input[name="due_date"]').val($(a).data("due_date")),$('#milestone input[name="milestone_order"]').val($(a).data("order")),$('#milestone textarea[name="description"]').val($(a).data("description")),$("#milestone").modal("show"),$("#milestone .add-title").addClass("hide")}function edit_discussion(a,b){$("#additional_discussion").append(hidden_input("id",b)),$('#discussion input[name="subject"]').val($(a).data("subject")),$('#discussion textarea[name="description"]').val($(a).data("description"));var c=$(a).data("show-to-customer"),d=!0;0==c&&(d=!1),$('#discussion input[name="show_to_customer"]').prop("checked",d),$("#discussion").modal("show"),$("#discussion .add-title").addClass("hide")}function mass_stop_timers(a){$.get(admin_url+"projects/mass_stop_timers/"+project_id+"/"+a,function(a){alert_float(a.type,a.message),setTimeout(function(){$("body").find(".modal-backdrop").eq(0).remove(),init_timers(),reload_tasks_tables(),pre_invoice_project()},500)},"json")}function pre_invoice_project(){$.get(admin_url+"projects/get_pre_invoice_project_info/"+project_id,function(a){$("#pre_invoice_project").html(a),$("#pre_invoice_project_settings").modal("show")})}function invoice_project(a){$("#pre_invoice_project_settings").modal("hide");var b={};b.type=$('input[name="invoice_data_type"]:checked').val(),b.project_id=a,b.tasks=$("#tasks_who_will_be_billed input:checkbox:checked").map(function(){return $(this).val()}).get(),b.expenses=$("#expenses_who_will_be_billed input:checkbox:checked").map(function(){return $(this).val()}).get(),$.post(admin_url+"projects/get_invoice_project_data/",b).done(function(a){$("#invoice_project").html(a),$("#invoice-project-modal").modal({show:!0,backdrop:"static"})})}function delete_project_discussion(a){var b=confirm(confirm_action_prompt);return 0!=b&&void $.get(admin_url+"projects/delete_discussion/"+a,function(a){alert_float(a.alert_type,a.message),$(".table-project-discussions").DataTable().ajax.reload()},"json")}function copy_project(){$("#copy_project").modal("show")}function projectExpenseSubmitHandler(a){return $.post(a.action,$(a).serialize()).done(function(a){a=JSON.parse(a),a.expenseid&&"undefined"!=typeof expenseDropzone&&expenseDropzone.getQueuedFiles().length>0?(expenseDropzone.options.url=admin_url+"expenses/add_expense_attachment/"+a.expenseid,expenseDropzone.processQueue()):window.location.assign(a.url)}),!1}function view_project_file(a,b){$("#project_file_data").empty(),$("#project_file_data").load(admin_url+"projects/file/"+a+"/"+project_id,function(a,b,c){"error"==b&&alert_float("danger",c.statusText)})}function update_file_data(a){var b={};b.id=a,b.subject=$('body input[name="file_subject"]').val(),b.description=$('body textarea[name="file_description"]').val(),$.post(admin_url+"projects/update_file_data/",b)}function project_mark_as_modal(a,b){$("#mark_tasks_finished_modal").modal("show"),$("#project_mark_status_confirm").attr("data-status-id",a),$("#project_mark_status_confirm").attr("data-project-id",project_id)}function confirm_project_status_change(a){var b={};$(a).attr("disabled",!0),b.project_id=$(a).data("project-id"),b.status_id=$(a).data("status-id"),b.mark_all_tasks_as_completed=$("#mark_all_tasks_as_completed").prop("checked")===!0?1:0,b.notify_project_members_status_change=$("#notify_project_members_status_change").prop("checked")===!0?1:0,$.post(admin_url+"projects/mark_as",b).done(function(a){a=JSON.parse(a),alert_float(a.success===!0?"success":"warning",a.message),setTimeout(function(){window.location.reload()},1500)}).fail(function(a){window.location.reload()})}$(window).on("load",function(){fix_phases_height()}),$(window).resize(function(){fix_phases_height()}),Dropzone.options.projectFilesUpload=!1,Dropzone.options.projectExpenseForm=!1;var expenseDropzone;$(function(){init_invoice();var a=get_url_param("file_id");if(a&&view_project_file(a,project_id),$("body").on("show.bs.modal","._project_file",function(){discussion_comments("#project-file-discussion",discussion_id,"file")}),$("body").on("shown.bs.modal","#milestone",function(){$("#milestone").find('input[name="name"]').focus()}),$("#timesheetsChart").length>0&&"undefined"!=typeof project_overview_chart){var b={type:"bar",data:{},options:{responsive:!0,maintainAspectRatio:!1,tooltips:{enabled:!0,mode:"single",callbacks:{label:function(a,b){return decimalToHM(a.yLabel)}}},scales:{yAxes:[{ticks:{beginAtZero:!0,min:0,userCallback:function(a,b,c){return decimalToHM(a)}}}]}}};b.data=project_overview_chart.data;var c=document.getElementById("timesheetsChart");timesheetsChart=new Chart(c,b)}$("#project_top").on("change",function(){var a=$(this).val(),b=get_url_param("group");b=b?"?group="+b:"",window.location.href=admin_url+"projects/view/"+a+b}),"undefined"!=typeof Dropbox&&$("#dropbox-chooser").length>0&&document.getElementById("dropbox-chooser").appendChild(Dropbox.createChooseButton({success:function(a){$.post(admin_url+"projects/add_external_file",{files:a,project_id:project_id,external:"dropbox",visible_to_customer:$("#pf_visible_to_customer").prop("checked")}).done(function(){var a=window.location.href;window.location.href=a.split("?")[0]+"?group=project_files"})},linkType:"preview",extensions:allowed_files.split(",")}));for(var d=-10;d<$(".task-phase").not(".color-not-auto-adjusted").length/2;d++){var e=120,f=169,g=56;$(".task-phase:eq("+(d+10)+")").not(".color-not-auto-adjusted").css("background",color(e-13*d,f-13*d,g-13*d)).css("border","1px solid "+color(e-13*d,f-13*d,g-13*d))}fix_phases_height(),$("body").on("click",".milestone-column .cpicker,.milestone-column .reset_milestone_color",function(a){a.preventDefault();var b=$(this).data("color"),c=$(this),d=c.parents(".milestone-column").data("milestone-id");$.post(admin_url+"projects/change_milestone_color",{color:b,milestone_id:d}).done(function(){""==b?window.location.reload():(c.parents(".milestone-column").find(".reset_milestone_color").removeClass("hide"),c.parents(".milestone-column").find(".panel-heading").addClass("color-white").removeClass("task-phase"),c.parents(".milestone-column").find(".edit-milestone-phase").addClass("color-white"))})}),$("body").find(".milestone-tasks-wrapper").sortable({connectWith:".ms-task",helper:"clone",items:"li.sortable",placeholder:"ui-sortable-placeholder",start:function(a,b){$(b.helper).addClass("tilt"),$(b.helper).find(".panel-body").css("background","#fbfbfb"),tilt_direction($(b.helper))},stop:function(a,b){$(b.helper).removeClass("tilt"),$("html").unbind("mousemove",$(b.helper).data("move_handler")),$(b.helper).removeData("move_handler")},update:function(a,b){if(this===b.item.parent()[0]){data={},data.order=[],data.milestone_id=$(b.item.parent()[0]).parents(".milestone-column").data("milestone-id"),data.task_id=$(b.item).data("task-id");var c=$(b.item.parent()[0]).parents(".milestone-column").find(".task"),d=0;$.each(c,function(){data.order.push([$(this).data("task-id"),d]),d++}),fix_phases_height(),setTimeout(function(){$.post(admin_url+"projects/update_task_milestone",data)},50)}}}),$("#project-files-upload").length>0&&(projectFilesUpload=new Dropzone("#project-files-upload",{paramName:"file",addRemoveLinks:!0,dictFileTooBig:file_exceds_maxfile_size_in_form,dictDefaultMessage:drop_files_here_to_upload,dictFallbackMessage:browser_not_support_drag_and_drop,dictRemoveFile:remove_file,accept:function(a,b){b()},success:function(a,b){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&window.location.reload()},acceptedFiles:allowed_files,error:function(a,b){alert_float("danger",b)},maxFilesize:max_php_ini_upload_size.replace(/\D/g,""),sending:function(a,b,c){c.append("visible_to_customer",$('input[name="visible_to_customer"]').prop("checked"))}})),$("#project-expense-form").length>0&&(expenseDropzone=new Dropzone("#project-expense-form",{autoProcessQueue:!1,clickable:"#dropzoneDragArea",acceptedFiles:allowed_files,previewsContainer:".dropzone-previews",dictDefaultMessage:drop_files_here_to_upload,dictFallbackMessage:browser_not_support_drag_and_drop,dictRemoveFile:remove_file,dictMaxFilesExceeded:you_can_not_upload_any_more_files,addRemoveLinks:!0,maxFiles:1,error:function(a,b){alert_float("danger",b)},success:function(a,b){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&window.location.reload()}})),_validate_form($("#project-expense-form"),{category:"required",date:"required",amount:"required",currency:"required"},projectExpenseSubmitHandler),gantt=$("#gantt").gantt({source:gantt_data,minScale:"years",maxScale:"years",itemsPerPage:20,months:JSON.parse(months_json),navigate:"scroll",onRender:function(){$("#gantt .leftPanel .name .fn-label:empty").parents(".name").css("background","initial");$("#gantt .leftPanel .spacer").html('<span class="gantt_project_name"><i class="fa fa-cubes"></i> '+$(".project-name").text()+"</span>");var a=$('input[name="project_percent"]').val();$("#gantt .leftPanel .spacer").append('<div style="padding:10px 20px 10px 20px;"><div class="progress mtop5 progress-bar-mini"><div class="progress-bar progress-bar-success no-percent-text" role="progressbar" aria-valuenow="'+a+'" aria-valuemin="0" aria-valuemax="100" style="width: 0%" data-percent="'+a+'"></div></div></div>'),init_progress_bars()},onItemClick:function(a){init_task_modal(a.task_id)},onAddClick:function(a,b){var c=new DateFormatter,d=new Date(+a),e=c.formatDate(d,date_format);new_task(admin_url+"tasks/task?rel_type=project&rel_id="+project_id+"&start_date="+e)}});var h={};$.each($("._hidden_inputs._filters input"),function(){h[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'}),_table_api=initDataTable(".table-project-expenses",admin_url+"projects/expenses/"+project_id,"undefined","undefined",h,[4,"DESC"]),_table_api&&_table_api.column(0).visible(!1,!1).columns.adjust(),init_rel_tasks_table(project_id,"project"),initDataTable(".table-notes",admin_url+"projects/notes/"+project_id,[4],[4],"undefined",[1,"DESC"]),initDataTable(".table-milestones",admin_url+"projects/milestones/"+project_id,[2],[2]);var i={};$.each($("._hidden_inputs._filters.timesheets_filters input"),function(){i[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'}),initDataTable(".table-timesheets",admin_url+"projects/timesheets/"+project_id,[6],[6],i,[3,"DESC"]),initDataTable(".table-project-discussions",admin_url+"projects/discussions/"+project_id,[4],[4],"undefined",[1,"DESC"]),_validate_form($("#milestone_form"),{name:"required",due_date:"required"}),_validate_form($("#copy_form"),{start_date:"required"}),_validate_form($("#discussion_form"),{subject:"required"},manage_discussion);var j={},k=$("#timesheet_form").find("select");$.each(k,function(){var a=$(this).attr("name");j[a]="required"}),j.start_time="required",j.end_time="required",_validate_form($("#timesheet_form"),j,manage_timesheets),$("#discussion").on("hidden.bs.modal",function(a){$('#discussion input[name="subject"]').val(""),$('#discussion textarea[name="description"]').val(""),$('#discussion input[name="show_to_customer"]').prop("checked",!0),$("#discussion .add-title").removeClass("hide"),$("#discussion .edit-title").removeClass("hide")}),$("#milestone").on("hidden.bs.modal",function(a){$("#additional_milestone").html(""),$('#milestone input[name="due_date"]').val(""),$('#milestone input[name="name"]').val(""),$('#milestone input[name="milestone_order"]').val($(".table-milestones tbody tr").length+1),$('#milestone textarea[name="description"]').val(""),$('#milestone input[name="description_visible_to_customer"]').prop("checked",!1),$("#milestone .add-title").removeClass("hide"),$("#milestone .edit-title").removeClass("hide")}),$("#timesheet").on("hidden.bs.modal",function(a){$('#timesheet select[name="timesheet_staff_id"]').removeAttr("data-staff_id"),$('#timesheet select[name="timesheet_staff_id"]').empty(),$('#timesheet select[name="timesheet_staff_id"]').selectpicker("refresh"),$('#timesheet select[name="timesheet_task_id"]').selectpicker("val",""),$("#timesheet #tags").tagit("removeAll"),$('input[name="timer_id"]').val("")}),$('#timesheet select[name="timesheet_task_id"]').on("change",function(){var a=$('#timesheet select[name="timesheet_staff_id"]'),b=$(this).val();if(""==b)return a.html(""),void a.selectpicker("refresh");var c;a.attr("data-staff_id")&&(c=a.attr("data-staff_id")),$.get(admin_url+"projects/timesheet_task_assignees/"+b+"/"+project_id+"/"+c,function(b){a.html(b),a.selectpicker("refresh")})}),$('input[name="tasks"].copy').on("change",function(){var a=$(this).prop("checked");if(a){var b=$('input[name="task_include_assignees"]').prop("checked"),c=$('input[name="task_include_followers"]').prop("checked");(b||c)&&$('input[name="members"].copy').prop("checked",!0)}}),$('input[name="task_include_assignees"],input[name="task_include_followers"]').on("change",function(){var a=$(this).prop("checked");1==a&&$('input[name="members"].copy').prop("checked",!0)}),$("body").on("change","#project_invoice_select_all_tasks,#project_invoice_select_all_expenses",function(){var a,b=$(this).prop("checked");a=$(this).hasClass("invoice_select_all_expenses")?'input[name="expenses[]"]':'input[name="tasks[]"]',1==b?$(a).prop("checked",!0):$(a).prop("checked",!1)}),$('input[name="members"].copy').on("change",function(){var a=$(this).prop("checked"),b=$('input[name="tasks"].copy').prop("checked");a?b&&($('input[name="task_include_assignees"]').prop("checked",!0),$('input[name="task_include_followers"]').prop("checked",!0)):b&&($('input[name="task_include_assignees"]').prop("checked",!1),$('input[name="task_include_followers"]').prop("checked",!1))})});